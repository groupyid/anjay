<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - PaTani</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='login.css') }}">
</head>
<body>
    <div class="login-gede" id="login-wrapper">
        <div class="logo-container" id="splash-screen">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo PaTani">
            <h1>P A T A N I</h1>
            <p class="paragraf">Platform terpadu untuk para pahlawan agrikultur Indonesia. Dapatkan wawasan, berdiskusi, dan kembangkan pertanian Anda bersama kami.</p>
            
            <div class="prompt-carousel">
                <div class="swiper-container">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="prompt-slide">
                                <div class="category-label">Tips & Trik</div>
                                <p class="text-prompt">"Bagaimana cara mengatasi hama wereng pada tanaman padi secara organik?"</p>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="category-label">Analisis Data</div>
                            <p class="text-prompt">"Analisis tren harga jagung di pasar regional selama 3 bulan terakhir."</p>
                        </div>
                        <div class="swiper-slide">
                            <div class="category-label">Rekomendasi</div>
                            <p class="text-prompt">"Rekomendasi pupuk terbaik untuk meningkatkan hasil panen tomat di dataran rendah."</p>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn-lanjut" id="next-button">Lanjutkan</button>
        </div>
        <div class="container-split" id="login-form-container">
            <div class="login-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo PaTani" class="login-form-logo">
                <h2>Login</h2>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        <script>
                            const flashedMessages = [
                                {% for category, message in messages %}
                                    { category: "{{ category }}", message: "{{ message }}" },
                                {% endfor %}
                            ];
                        </script>
                    {% endif %}
                {% endwith %}

                <form method="POST" action="{{ url_for('login') }}" autocomplete="off">
                    <label for="email">Alamat Email</label>
                    <input type="email" id="email" name="email" placeholder="contoh@email.com" required autocomplete="off">
                    
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Masukkan password Anda" required autocomplete="new-password">
                    
                    <button type="submit" class="btn-masuk">Masuk</button>
                </form>
                <div class="register">
                    <p>Belum punya akun? <a href="{{ url_for('daftar_petani') }}">Daftar di sini</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- The Modal -->
    <div id="errorModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalTitle">Peringatan!</h2>
            <p id="modalMessage"></p>
        </div>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script>
        var swiper = new Swiper('.swiper-container', {
            loop: true,
            autoplay: {
                delay: 4000,
                disableOnInteraction: false,
            },
            effect: 'fade',
            fadeEffect: {
                crossFade: true
            },
        });

        document.addEventListener('DOMContentLoaded', function() {
            const nextButton = document.getElementById('next-button');
            const splashScreen = document.getElementById('splash-screen');
            const loginFormContainer = document.getElementById('login-form-container');
            const loginWrapper = document.getElementById('login-wrapper');

            console.log('DOM Content Loaded.');
            console.log('nextButton element:', nextButton);
            if (nextButton) {
                console.log('nextButton computed style display:', getComputedStyle(nextButton).display);
                console.log('nextButton computed style pointer-events:', getComputedStyle(nextButton).pointerEvents);
                console.log('splashScreen computed style display:', getComputedStyle(splashScreen).display);
                console.log('splashScreen computed style pointer-events:', getComputedStyle(splashScreen).pointerEvents);
            }

            // Check if there are any flashed messages (e.g., login errors)
            const hasFlashedMessages = (typeof flashedMessages !== 'undefined' && flashedMessages.length > 0);
            console.log('hasFlashedMessages (JS):', hasFlashedMessages);

            // Attach event listener to nextButton regardless of screen size
            if (nextButton) {
                console.log('Attaching click listener to nextButton.');
                nextButton.addEventListener('click', function() {
                    console.log('Next button clicked!');
                    splashScreen.style.display = 'none';
                    loginFormContainer.style.display = 'flex';
                    loginWrapper.style.height = 'auto'; // Allow wrapper to adjust height
                });
            } else {
                console.error('Next button element not found!');
            }

            // Initial setup based on screen size and flashed messages
            if (window.innerWidth <= 900) {
                // Mobile view
                if (hasFlashedMessages) {
                    // If there are messages, show login form directly
                    splashScreen.style.display = 'none';
                    loginFormContainer.style.display = 'flex';
                    loginWrapper.style.height = 'auto';
                    console.log('Mobile: Flashed messages detected. Showing login form.');
                } else {
                    // Otherwise, show splash screen first
                    splashScreen.style.display = 'flex';
                    loginFormContainer.style.display = 'none';
                    console.log('Mobile: No flashed messages. Showing splash screen.');
                }
            } else {
                // Desktop view (handled by CSS, just ensure classes are correct if JS overrides)
                splashScreen.style.display = 'flex';
                loginFormContainer.style.display = 'flex';
            }

            console.log('Initial setup complete.');
            console.log('splashScreen display after setup:', splashScreen.style.display);
            console.log('loginFormContainer display after setup:', loginFormContainer.style.display);

            // Modal Logic
            const modal = document.getElementById('errorModal');
            const modalMessage = document.getElementById('modalMessage');
            const closeButton = document.querySelector('.close-button');

            if (typeof flashedMessages !== 'undefined' && flashedMessages.length > 0) {
                // Assuming we only care about the first message for the popup
                const errorMessage = flashedMessages[0].message;
                modalMessage.textContent = errorMessage;
                modal.style.display = 'flex'; // Use flex to center content
                console.log('Modal displayed.');
            }

            closeButton.onclick = function() {
                modal.style.display = 'none';
                console.log('Modal closed by button.');
                console.log('splashScreen display after modal close:', splashScreen.style.display);
                console.log('loginFormContainer display after modal close:', loginFormContainer.style.display);
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                    console.log('Modal closed by clicking outside.');
                    console.log('splashScreen display after modal close:', splashScreen.style.display);
                    console.log('loginFormContainer display after modal close:', loginFormContainer.style.display);
                }
            }
        });
    </script>
    <script>
        // Auto Location Detection System
        let locationDetectionAttempted = false;
        
        async function requestLocationPermission() {
            if (locationDetectionAttempted) return;
            locationDetectionAttempted = true;
            
            if (!('geolocation' in navigator)) {
                console.log('Geolocation tidak didukung browser');
                return;
            }
            
            try {
                console.log('Meminta izin akses lokasi...');
                
                // Show loading notification
                showLocationMessage('info', 'Meminta izin akses lokasi untuk mendeteksi region Anda...');
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 300000 // 5 minutes cache
                    });
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                console.log(`Lokasi terdeteksi: ${lat}, ${lon}`);
                showLocationMessage('success', 'Lokasi berhasil terdeteksi! Mengidentifikasi region...');
                
                // Send location to server for region detection
                const response = await fetch('/update_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lon
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.region) {
                        showLocationMessage('success', `Region Anda: ${data.region}`, 5000);
                        console.log(`Region terdeteksi: ${data.region}`);
                    } else {
                        showLocationMessage('success', 'Lokasi berhasil disimpan!', 3000);
                    }
                } else {
                    console.log('Failed to update location on server');
                    showLocationMessage('warning', 'Lokasi terdeteksi, namun gagal menyimpan ke server', 3000);
                }
                
            } catch (error) {
                console.log('Location detection error:', error.message);
                
                if (error.code === 1) { // PERMISSION_DENIED
                    showLocationMessage('warning', 'Izin akses lokasi ditolak. Region akan dideteksi dari data chat Anda.', 5000);
                } else if (error.code === 2) { // POSITION_UNAVAILABLE
                    showLocationMessage('warning', 'Lokasi tidak dapat dideteksi. Pastikan GPS aktif.', 4000);
                } else if (error.code === 3) { // TIMEOUT
                    showLocationMessage('warning', 'Timeout deteksi lokasi. Silakan coba lagi.', 3000);
                } else {
                    showLocationMessage('info', 'Deteksi lokasi tidak tersedia, menggunakan fallback.', 3000);
                }
            }
        }
        
        function showLocationMessage(type, message, duration = 3000) {
            // Remove existing location messages
            const existingMessages = document.querySelectorAll('.location-message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `location-message alert alert-${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 350px;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Set background color based on type
            const colors = {
                'info': '#e3f2fd',
                'success': '#e8f5e8', 
                'warning': '#fff3cd',
                'error': '#f8d7da'
            };
            messageDiv.style.backgroundColor = colors[type] || colors.info;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Auto remove after duration
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, duration);
        }
        
        // CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Trigger location detection on successful login
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user just logged in successfully (redirect from login with session)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('session') || window.location.pathname === '/index') {
                // Delay to ensure user is logged in
                setTimeout(requestLocationPermission, 1000);
            }
            
            // Also trigger on form submission success
            const loginForm = document.querySelector('form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    // Don't prevent default, let login proceed
                    // Location detection will trigger after successful login redirect
                });
            }
        });
    </script>
</body>
</html>