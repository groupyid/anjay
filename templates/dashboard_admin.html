<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <style>
        /* Enhanced styles for new features */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .nav-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #6c757d;
        }
        .nav-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .tab-content {
            display: block;
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .user-table th,
        .user-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .user-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        .user-table tr:hover {
            background: #f8f9fa;
        }
        .action-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .btn-edit {
            background: #28a745;
            color: white;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-view {
            background: #007bff;
            color: white;
        }
        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .export-btn {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .export-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .analytics-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-small {
            height: 200px;
            margin-top: 16px;
        }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .alert-danger {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .activity-log {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
        }
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
        }
        .log-time {
            color: #6c757d;
            font-size: 12px;
        }
        
        /* Notification System */
        .notification-center {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 1001;
            max-width: 350px;
        }
        
        .notification {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color);
            animation: slideInRight 0.4s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .notification.success {
            border-left-color: #28a745;
        }
        
        .notification.warning {
            border-left-color: #ffc107;
        }
        
        .notification.error {
            border-left-color: #dc3545;
        }
        
        .notification-header {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover {
            color: #666;
        }
        
        .notification-body {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-bell {
            position: relative;
            cursor: pointer;
            margin-left: 16px;
            padding: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="logout-container">
        <div class="notification-bell" onclick="toggleNotifications()" title="Notifications">
            üîî
            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>

    <!-- Notification Center -->
    <div class="notification-center" id="notificationCenter"></div>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Dashboard Admin</h1>
            <p>Analisis Interaksi Petani & Early Warning System</p>
        </header>

        <!-- Single Tab Dashboard -->
        <div class="nav-tabs" style="display: none;">
            <button class="nav-tab active">Dashboard</button>
        </div>

        <!-- Overview Tab (Original Content) -->
        <div id="overview" class="tab-content active">
            

            {% if ews and ews|length > 0 %}
            <div class="card ews-card">
                <h2>‚ö†Ô∏è Early Warning System</h2>
                <ul>
                    {% for w in ews %}
                    <li>
                        <b>Topik:</b> <span class="topic">{{ w.topik }}</span> &mdash; <b>Wilayah:</b> <span class="region">{{ w.region }}</span><br>
                        <small>Dibahas oleh <b>{{ w.user_count }}</b> user, <b>{{ w.chat_count }}</b> chat minggu ini.</small>
                    </li>
                    {% endfor %}
                </ul>
                <div class="footer">Segera lakukan advokasi atau tindak lanjut jika diperlukan.</div>
            </div>
            {% endif %}

            <main class="dashboard-grid">
                <section class="card">
                    <h2 class="card-header">Analisis Tren Topik</h2>
                    
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label for="filter-province">Provinsi</label>
                            <select id="filter-province">
                                <option value="">Semua Provinsi</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="admin-region">Kab/Kota</label>
                            <select id="admin-region">
                                <option value="">Semua Kab/Kota</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="trend-period">Periode</label>
                            <select id="trend-period">
                                <option value="day">Harian</option>
                                <option value="week" selected>Mingguan</option>
                                <option value="month">Bulanan</option>
                            </select>
                        </div>
                         <div class="filter-group">
                            <label for="trend-days">Rentang</label>
                            <select id="trend-days">
                                <option value="30">30 hari</option>
                                <option value="90" selected>90 hari</option>
                                <option value="180">180 hari</option>
                            </select>
                        </div>

                    </div>

                    <div class="chart-container">
                        <canvas id="trendChart" height="220"></canvas>
                        <div id="chart-fallback" style="display:block; text-align:center; padding:40px; color:#666; border:1px dashed #ccc; border-radius:8px; background:#f9f9f9;">
                            <h3>üìä Chart Loading...</h3>
                            <p>Trend chart will appear here when data loads</p>
                            <small>If this message persists, check browser console for errors</small>
                        </div>
                    </div>

                    <h3 class="card-header" style="font-size: 1.3em; border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 16px;">Statistik & Insight</h3>
                    <div id="statistik-pengguna">
                        <ul class="insight-list">
                            <li>Jumlah pertanyaan minggu ini: <b>{{ jumlah_pertanyaan }}</b></li>
                            {% if selected_region or selected_province_id %}
                            <li>Wilayah aktif: <b>{{ wilayah_aktif }}</b></li>
                            {% endif %}
                            <li>Jam aktif tertinggi: <b>{{ jam_aktif_tertinggi or '-' }}</b></li>
                            <li>Rata-rata pertanyaan per user: <b>{{ rata2_pertanyaan_per_user or '-' }}</b></li>
                        </ul>
                    </div>
                </section>

                <section class="card">
                    <h2 class="card-header">Peta Sebaran & Topik Regional</h2>
                    
                    <div class="filter-bar">
                        <div class="filter-group">
                            <label for="filter-topic">Topik Peta</label>
                            <select id="filter-topic">
                                <option value="">Semua Topik</option>
                                {% for t in all_topics %}
                                <option value="{{ t }}">{{ t }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="map-days">Rentang Peta</label>
                            <select id="map-days">
                                <option value="30" selected>30 hari</option>
                                <option value="90">90 hari</option>
                                <option value="180">180 hari</option>
                            </select>
                        </div>
                    </div>

                    <div class="map-container">
                        <div id="map"></div>
                        <div id="map-fallback" style="display:flex; text-align:center; padding:40px; color:#666; border:1px dashed #ccc; border-radius:8px; height:350px; flex-direction:column; justify-content:center; align-items:center; background:#f9f9f9;">
                            <h3>üó∫Ô∏è Map Loading...</h3>
                            <p>Interactive map will appear here when data loads</p>
                            <small>If this message persists, check browser console for errors</small>
                        </div>
                        <p class="map-caption">Titik menampilkan agregasi per wilayah untuk topik terpilih.</p>
                    </div>

                    <!-- Provincial Topics Selection -->
                    <div class="filter-bar" style="margin-top: 20px;">
                        <div class="filter-group">
                            <label for="provincial-topics-filter">Lihat Tren Topik Provinsi:</label>
                            <select id="provincial-topics-filter">
                                <option value="">Pilih Provinsi</option>
                                <!-- Provinces will be populated dynamically -->
                            </select>
                        </div>
                        <button class="export-btn" onclick="loadProvincialTopics()" style="margin-left: 10px;">üîÑ Refresh</button>
                    </div>

                    <div id="provincial-view" class="regional-topics-container">
                        <h4 id="provincial-title">üìç Pilih provinsi untuk melihat tren topik</h4>
                        <div class="topic-list-card" id="provincial-topics-content">
                            <p style="text-align:center; color: var(--text-secondary); padding: 40px;">
                                <i>Silakan pilih provinsi dari dropdown di atas untuk melihat tren topik populer di wilayah tersebut.</i>
                            </p>
                        </div>
                    </div>

                    {% if topic_by_region %}
                    <div class="filter-bar" style="margin-top: 16px;">
                        <div class="filter-group">
                            <label for="regional-filter">Lihat Tren Topik di:</label>
                            <select id="regional-filter">
                                <option value="">Nasional (Semua Daerah)</option>
                                {% for region in topic_by_region.keys() %}
                                <option value="{{ region }}">{{ region }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div id="regional-topics-container" class="regional-topics-container">
                        <div id="single-region-view" style="display:none;">
                            {% for region, topics in topic_by_region.items() %}
                            <div class="single-region-data" data-region="{{ region }}" style="display:none;">
                                <h4>üìç {{ region }}</h4>
                                <div class="topic-list-card">
                                    {% if topics %}
                                        <h5>Topik Terpopuler:</h5>
                                        <ol>
                                            {% for topic, count in topics.most_common(10) %}
                                            <li><b>{{ topic }}</b>: {{ count }} pertanyaan</li>
                                            {% endfor %}
                                        </ol>
                                    {% else %}
                                        <p style="text-align:center; color: var(--text-secondary);"><i>Tidak ada data topik untuk daerah ini.</i></p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </section>
            </main>
        </div>






    </div>



    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
    // Check if libraries loaded
    console.log('Libraries status:', {
        Chart: typeof Chart !== 'undefined',
        L: typeof L !== 'undefined'
    });
    
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load');
        // Immediately show chart fallback
        setTimeout(() => {
            const chartCanvas = document.getElementById('trendChart');
            const chartFallback = document.getElementById('chart-fallback');
            if (chartCanvas && chartFallback) {
                chartCanvas.style.display = 'none';
                chartFallback.style.display = 'block';
                chartFallback.innerHTML = '<h3>‚ùå Chart.js Failed to Load</h3><p>Please check internet connection</p>';
            }
        }, 100);
    }
    if (typeof L === 'undefined') {
        console.error('Leaflet.js failed to load');
        // Immediately show map fallback
        setTimeout(() => {
            const mapContainer = document.getElementById('map');
            const mapFallback = document.getElementById('map-fallback');
            if (mapContainer && mapFallback) {
                mapContainer.style.display = 'none';
                mapFallback.style.display = 'flex';
                mapFallback.innerHTML = '<h3>‚ùå Leaflet.js Failed to Load</h3><p>Please check internet connection</p>';
            }
        }, 100);
    }
    // Single dashboard - no tabs needed
    // Initialize dashboard content on load

    // Utility Functions

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        const container = document.querySelector('.dashboard-container');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Essential Functions Only
     async function loadAnalytics() {
         try {
             const response = await fetch('/api/admin/analytics');
             const data = await response.json();
             
             // Load charts immediately without delay
             loadRegistrationChart(data.registration_trend);
             loadRegionActivityChart(data.region_activity);
             
             // Update performance metrics
             document.getElementById('avg-response-time').textContent = data.avg_response_time || '-';
             document.getElementById('total-queries').textContent = data.total_queries || '-';
             document.getElementById('error-rate').textContent = data.error_rate || '-';
         } catch (error) {
             console.error('Error loading analytics:', error);
         }
     }

    let registrationChart = null;
    let regionActivityChart = null;

    function loadRegistrationChart(data) {
        const ctx = document.getElementById('registrationChart').getContext('2d');
        
        // Destroy existing chart to prevent exponential growth
        if (registrationChart) {
            registrationChart.destroy();
        }
        
        registrationChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'New Registrations',
                    data: data.values || [],
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(46, 125, 50, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    function loadRegionActivityChart(data) {
        const ctx = document.getElementById('regionActivityChart').getContext('2d');
        
        // Destroy existing chart to prevent exponential growth
        if (regionActivityChart) {
            regionActivityChart.destroy();
        }
        
        regionActivityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Chat Activity',
                    data: data.values || [],
                    backgroundColor: 'var(--primary-color)',
                    borderRadius: 4,
                    borderWidth: 1,
                    borderColor: 'var(--primary-dark)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // System Logs Functions
    // loadSystemLogs function removed - system logs tab deleted

    // Form submission handlers removed - user management forms deleted

    // Event listeners for log filters - REMOVED (system logs tab deleted)

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    // ============ Chart: Tren Topik ==========
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    let trendChart = null;
    // Global element references - moved to DOMContentLoaded for safety
    const preselectedRegion = "{{ selected_region or '' }}";
    const preselectedProvinceId = "{{ selected_province_id or '' }}";

    function randomColor(seed) {
        let h = 0;
        for (let i = 0; i < seed.length; i++) h = (h * 31 + seed.charCodeAt(i)) % 360;
        const s = 70, l = 50;
        return `hsl(${h}, ${s}%, ${l}%)`;
    }

    async function populateProvinces() {
        try {
            const provinceElement = document.getElementById('filter-province');
            if (!provinceElement) {
                console.error('Province dropdown not found');
                return;
            }
            
            const json = await cachedFetch('/api/admin/provinces');
            const provinces = json.provinces || [];
            
            // Clear existing options except first
            for (let i = provinceElement.options.length - 1; i >= 1; i--) {
                provinceElement.remove(i);
            }
            
            provinces.forEach(p => {
                const opt = document.createElement('option');
                opt.value = String(p.id);
                opt.textContent = p.name;
                if (preselectedProvinceId && String(p.id) === String(preselectedProvinceId)) opt.selected = true;
                provinceElement.appendChild(opt);
            });
            
            console.log(`Populated ${provinces.length} provinces`);
        } catch (e) {
            console.error('Gagal memuat provinsi', e);
        }
    }

    async function populateRegencies(provinceId) {
        const regionElement = document.getElementById('admin-region');
        if (!regionElement) {
            console.error('Region dropdown not found');
            return;
        }
        
        // Clear existing options except first
        for (let i = regionElement.options.length - 1; i >= 1; i--) {
            regionElement.remove(i);
        }
        
        if (!provinceId) return;
        
        try {
            const res = await fetch(`/api/admin/regencies?province_id=${encodeURIComponent(provinceId)}`);
            const json = await res.json();
            const regs = json.regencies || [];
            regs.forEach(r => {
                const opt = document.createElement('option');
                const shortName = r.name.replace(/^KABUPATEN\s+|^KOTA\s+/, '');
                opt.value = shortName;
                opt.textContent = shortName;
                if (preselectedRegion && preselectedRegion === shortName && String(provinceId) === String(preselectedProvinceId)) {
                    opt.selected = true;
                }
                regionElement.appendChild(opt);
            });
            console.log(`Populated ${regs.length} regencies for province ${provinceId}`);
        } catch (e) {
            console.error('Gagal memuat kab/kota', e);
        }
    }

    async function refreshInsightCount() {
        try {
            const period = document.getElementById('trend-period').value;
            const days = document.getElementById('trend-days').value;
            const region = document.getElementById('admin-region').value;
            const provinceId = document.getElementById('filter-province').value;
            const params = new URLSearchParams({ period, days, region, province_id: provinceId });
            const res = await fetch(`/api/admin/trends?${params.toString()}`);
            const data = await res.json();
            const total = (data.matrix || []).reduce((sum, row) => sum + row.reduce((a,b)=>a+b,0), 0);
            const el = document.querySelector('#statistik-pengguna li:first-child');
            if (el) el.innerHTML = `Jumlah pertanyaan minggu ini: <b>${total}</b>`;
        } catch (e) { /* silent */ }
    }
    
    async function loadTrendChart() {
         try {
             const periodElement = document.getElementById('trend-period');
             const daysElement = document.getElementById('trend-days');
             const regionElement = document.getElementById('admin-region');
             const provinceElement = document.getElementById('filter-province');
             
             const period = periodElement?.value || 'week';
             const days = daysElement?.value || '90';
             const region = regionElement?.value || '';
             const provinceId = provinceElement?.value || '';
             
             console.log(`üìä Chart parameters:`, {
                 period, days, region, provinceId,
                 hasProvinceElement: !!provinceElement,
                 provinceElementValue: provinceElement?.value
             });
             const params = new URLSearchParams({ period, days, region, province_id: provinceId });
             console.log(`üìä Chart API call: /api/admin/trends?${params.toString()}`);
             
             const res = await fetch(`/api/admin/trends?${params.toString()}`);
             if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
             const data = await res.json();
             
             console.log(`üìä Chart API response for province ${provinceId}:`, data);
             if (data.error) throw new Error(data.error);
             
             const labels = data.labels || [];
             const topics = data.topics || [];
             const matrix = data.matrix || [];
             
             const datasets = topics.map((t, idx) => {
                 const color = randomColor(t);
                 return {
                     label: t,
                     data: matrix[idx] || [],
                     borderColor: color,
                     backgroundColor: color.replace('hsl', 'hsla').replace('%)', '%, 0.15)'),
                     tension: 0.3,
                     fill: true,
                     pointRadius: 2,
                     pointHoverRadius: 5
                 };
             });

             if (trendChart) trendChart.destroy();
             
             const options = {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                     legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } },
                     tooltip: { mode: 'index', intersect: false }
                 },
                 interaction: { mode: 'nearest', axis: 'x', intersect: false },
                 scales: {
                     x: { title: { display: true, text: 'Tanggal' }, grid: { display: false } },
                     y: { title: { display: true, text: 'Jumlah Pertanyaan' }, beginAtZero: true, ticks: { precision: 0 } }
                 }
             };

             if (labels.length === 0 || datasets.length === 0) {
                 const regionElement = document.getElementById('admin-region');
                const provinceElement = document.getElementById('filter-province');
                const regionText = regionElement?.value || (provinceElement?.options[provinceElement?.selectedIndex]?.text || 'filter yang dipilih');
                 options.plugins.title = { display: true, text: `Tidak ada data untuk ${regionText}`, font: { size: 16 }, color: '#999' };
             }
             
             trendChart = new Chart(trendCtx, { type: 'line', data: { labels, datasets }, options });
             
                         const topicElement = document.getElementById('filter-topic');
            if (topicElement && !topicElement.value && topics.length > 0) {
                topicElement.value = topics[0];
            }
             await refreshInsightCount();
         } catch (error) {
             console.error('Error loading trend chart:', error);
             if (trendChart) trendChart.destroy();
         }
    }

    // ============ Peta: Distribusi Topik ==========
    const defaultCenter = [-2.5, 117];
    let map = null;
    let bubbleLayer = null;

    // Alternative: Browser-based auto location detection
    async function enableAutoLocationDetection() {
        if ('geolocation' in navigator) {
            try {
                console.log('Browser geolocation available, requesting permission...');
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 600000 // 10 minutes cache
                    });
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                console.log(`Browser detected location: ${lat}, ${lon}`);
                
                // Reverse geocode to get region name
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=id`);
                const data = await response.json();
                
                if (data && data.address) {
                    const detectedRegion = data.address.city || data.address.county || data.address.state || data.address.country;
                    console.log(`Auto-detected region: ${detectedRegion}`);
                    
                    showNotification({
                        type: 'info',
                        title: 'Auto Location Detected',
                        message: `Detected location: ${detectedRegion}`,
                        duration: 5000
                    });
                    
                    return { lat, lon, region: detectedRegion };
                }
            } catch (error) {
                console.log('Browser geolocation failed:', error.message);
                showNotification({
                    type: 'warning', 
                    title: 'Auto Location Failed',
                    message: 'Using manual coordinate mapping instead',
                    duration: 3000
                });
            }
        } else {
            console.log('Browser geolocation not available');
        }
        return null;
    }

    // Enhanced map initialization with auto-detection options
    async function initMap() {
        if (map) {
            return;
        }
        
        // Ensure map container exists and is visible
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('Map container not found');
            return;
        }
        
        // Initialize map immediately - no delays
        try {
            map = L.map('map').setView(defaultCenter, 4.5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            bubbleLayer = L.layerGroup().addTo(map);
            
            // Load bubbles immediately after map creation
            renderTopicBubbles(topicEl?.value || '', mapDaysEl?.value || '30');
        } catch (error) {
            console.error('Error initializing map:', error);
        }
    }

    function radiusFromCount(count) {
        return 6 + Math.log(count + 1) * 5;
    }

         async function renderTopicBubbles(topic, days) {
         if (!map || !bubbleLayer) {
             console.warn('Map not initialized yet, skipping bubble rendering');
             return;
         }
         
         bubbleLayer.clearLayers();
                 const regionElement = document.getElementById('admin-region');
        const provinceElement = document.getElementById('filter-province');
        const region = regionElement?.value || '';
        const provinceId = provinceElement?.value || '';
         const topicParam = topic || '';
         const params = new URLSearchParams({ topic: topicParam, days, region, province_id: provinceId });
         
         console.log(`üó∫Ô∏è Map API call: /api/admin/topic-distribution?${params.toString()}`);
         
                   try {
              const res = await fetch(`/api/admin/topic-distribution?${params.toString()}`);
              if (!res.ok) {
                  const errorText = await res.text();
                  throw new Error(`HTTP ${res.status}: ${errorText}`);
              }
              const json = await res.json();
              
              console.log(`üó∫Ô∏è Map API response for province ${provinceId}:`, json);
              
              if (json.error) {
                  throw new Error(json.error);
              }
              
              const markers = json.markers || [];
              
              console.log('Received markers:', markers);
             
             if (markers.length === 0) {
                 console.log('No markers found, setting default view');
                 map.setView(defaultCenter, 4.5);
                 
                                   // Show a brief message on the map
                  const noDataPopup = L.popup()
                      .setLatLng(defaultCenter)
                      .setContent('Tidak ada data untuk filter yang dipilih')
                      .openOn(map);
                  
                  // Auto-close popup after 2 seconds instead of 3
                  setTimeout(() => {
                      map.closePopup(noDataPopup);
                  }, 2000);
                 return;
             }
             
             const bounds = [];
             markers.forEach(m => {
                 console.log(`Adding marker for ${m.region} at [${m.lat}, ${m.lon}] with count ${m.count}`);
                 
                 const circle = L.circleMarker([m.lat, m.lon], {
                     radius: radiusFromCount(m.count),
                     color: '#2e7d32',
                     fillColor: '#66bb6a',
                     fillOpacity: 0.7,
                     weight: 2
                 }).bindPopup(`
                     <div style="text-align: center;">
                         <b>${m.region}</b><br>
                         <span style="color: #666;">Topik: ${m.topic || 'Semua'}</span><br>
                         <span style="color: #2e7d32; font-weight: bold;">Jumlah: ${m.count}</span>
                     </div>
                 `);
                 circle.addTo(bubbleLayer);
                 bounds.push([m.lat, m.lon]);
             });
             
             if (bounds.length > 0) {
                 map.fitBounds(bounds, { padding: [40, 40], maxZoom: 10 });
                 console.log('Map fitted to bounds:', bounds);
             }
         } catch (error) {
             console.error('Error fetching topic distribution:', error);
             map.setView(defaultCenter, 4.5);
             
             // Show error message
             showNotification('error', 'Map Error', 'Gagal memuat data peta', true);
         }
     }

    // ============ Event Listeners & Initialization ==========
    // All element references and event listeners are now set up in DOMContentLoaded

    function addDebouncedListener(element, event, func, delay) {
        let timeout;
        element.addEventListener(event, (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), delay);
        });
    }

    // Event listeners will be set up in DOMContentLoaded

    // Provincial Topics Functions
    async function populateProvincialFilter() {
        try {
            const json = await cachedFetch('/api/admin/provinces');
            const provinces = json.provinces || [];
            const provincialFilter = document.getElementById('provincial-topics-filter');
            
            if (provincialFilter) {
                // Clear existing options except the first one
                for (let i = provincialFilter.options.length - 1; i >= 1; i--) {
                    provincialFilter.remove(i);
                }
                
                provinces.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = String(p.id);
                    opt.textContent = p.name;
                    provincialFilter.appendChild(opt);
                });
            }
        } catch (e) {
            console.error('Gagal memuat provinsi untuk filter', e);
        }
    }

    async function loadProvincialTopics() {
        const provincialFilter = document.getElementById('provincial-topics-filter');
        const provinceId = provincialFilter ? provincialFilter.value : '';
        
        if (!provinceId) {
            showAlert('Silakan pilih provinsi terlebih dahulu', 'warning');
            return;
        }

        try {
            const response = await fetch(`/api/admin/provincial-topics?province_id=${provinceId}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            const provinceName = provincialFilter.options[provincialFilter.selectedIndex].text;
            const titleElement = document.getElementById('provincial-title');
            const contentElement = document.getElementById('provincial-topics-content');
            
            titleElement.textContent = `üìç Tren Topik Populer - ${provinceName}`;
            
            if (data.topics && data.topics.length > 0) {
                let html = '<h5>Topik Terpopuler:</h5><ol>';
                data.topics.forEach(topic => {
                    html += `<li><b>${topic.name}</b>: ${topic.count} pertanyaan</li>`;
                });
                html += '</ol>';
                html += `<div class="footer-note">üìä Data dari ${data.total_questions} pertanyaan di ${provinceName}</div>`;
                contentElement.innerHTML = html;
            } else {
                contentElement.innerHTML = `
                    <p style="text-align:center; color: var(--text-secondary); padding: 40px;">
                        <i>Belum ada data topik untuk provinsi ${provinceName}.</i>
                    </p>
                `;
            }
        } catch (error) {
            console.error('Error loading provincial topics:', error);
            showAlert('Gagal memuat data topik provinsi', 'danger');
        }
    }

    // Provincial filter change handler
    document.addEventListener('DOMContentLoaded', function() {
        const provincialFilter = document.getElementById('provincial-topics-filter');
        if (provincialFilter) {
            provincialFilter.addEventListener('change', function() {
                if (this.value) {
                    loadProvincialTopics();
                } else {
                    const titleElement = document.getElementById('provincial-title');
                    const contentElement = document.getElementById('provincial-topics-content');
                    
                    titleElement.textContent = 'üìç Pilih provinsi untuk melihat tren topik';
                    contentElement.innerHTML = `
                        <p style="text-align:center; color: var(--text-secondary); padding: 40px;">
                            <i>Silakan pilih provinsi dari dropdown di atas untuk melihat tren topik populer di wilayah tersebut.</i>
                        </p>
                    `;
                }
            });
        }
    });

    const regionalFilterElement = document.getElementById('regional-filter');

    // PENTING: Hanya tambahkan event listener jika elemennya benar-benar ada di halaman
    if (regionalFilterElement) {
        regionalFilterElement.addEventListener('change', function() {
            const selectedRegion = this.value;
            const singleRegionView = document.getElementById('single-region-view');

            if (singleRegionView) singleRegionView.style.display = (selectedRegion === '') ? 'none' : 'block';

            document.querySelectorAll('.single-region-data').forEach(card => {
                card.style.display = (card.dataset.region === selectedRegion) ? 'block' : 'none';
            });
        });
    }

                          // Cache for API responses
       const apiCache = new Map();
       const CACHE_DURATION = 30000; // 30 seconds

       // Cached fetch function
       async function cachedFetch(url) {
           const now = Date.now();
           const cached = apiCache.get(url);
           
           if (cached && (now - cached.timestamp) < CACHE_DURATION) {
               return cached.data;
           }
           
           const response = await fetch(url);
           const data = await response.json();
           
           apiCache.set(url, {
               data: data,
               timestamp: now
           });
           
           return data;
       }

       window.addEventListener('DOMContentLoaded', async () => {
           console.log('Dashboard initializing...');
           
           // Force show overview content (backup plan)
           const overviewTab = document.getElementById('overview');
           if (overviewTab) {
               overviewTab.style.display = 'block';
               overviewTab.style.visibility = 'visible';
               console.log('Overview tab forced visible');
           }
           
           // Ensure all elements exist before proceeding
           const topicElement = document.getElementById('filter-topic');
           const mapDaysElement = document.getElementById('map-days');
           
           console.log('Elements found:', {
               topicElement: !!topicElement,
               mapDaysElement: !!mapDaysElement,
               overview: !!overviewTab
           });
           
           if (!topicElement || !mapDaysElement) {
               console.error('Required elements not found:', {topicElement, mapDaysElement});
               return;
           }
           
           // Use Promise.all for parallel initialization
           const initPromises = [
               populateProvinces().catch(e => console.error('populateProvinces failed:', e)),
               populateProvincialFilter().catch(e => console.error('populateProvincialFilter failed:', e))
           ];
           
           await Promise.all(initPromises);
           console.log('Provinces and filters populated (some may have failed)');
           
           if (preselectedProvinceId) {
               await populateRegencies(preselectedProvinceId);
           }
           
           // Initialize map only when overview tab is active
           if (overviewTab && overviewTab.classList.contains('active')) {
               console.log('Initializing map...');
               if (typeof L !== 'undefined') {
                   initMap();
               } else {
                   console.error('Leaflet not loaded, showing fallback');
                   const mapContainer = document.getElementById('map');
                   const mapFallback = document.getElementById('map-fallback');
                   if (mapContainer && mapFallback) {
                       mapContainer.style.display = 'none';
                       mapFallback.style.display = 'flex';
                   }
               }
           }
           
           // Set up all event listeners
           const periodElement = document.getElementById('trend-period');
           const daysElement = document.getElementById('trend-days');

           const provinceElement = document.getElementById('filter-province');
           const regionElement = document.getElementById('admin-region');
           
           // Chart event listeners
           if (periodElement) {
               addDebouncedListener(periodElement, 'change', loadTrendChart, 200);
           }
           if (daysElement) {
               addDebouncedListener(daysElement, 'change', loadTrendChart, 200);
           }
           
           // Province filter listener
           if (provinceElement) {
               provinceElement.addEventListener('change', async () => {
                   const pid = provinceElement.value;
                   const selectedOption = provinceElement.options[provinceElement.selectedIndex];
                   const provinceName = selectedOption ? selectedOption.text : 'Unknown';
                   
                   console.log(`üèôÔ∏è Province changed: ${provinceName} (ID: ${pid})`);
                   
                   await populateRegencies(pid);
                   if (regionElement) regionElement.value = '';
                   history.replaceState(null, '', `${window.location.pathname}?province_id=${pid}`);
                   
                   console.log(`üìä Loading chart for province: ${provinceName}`);
                   await loadTrendChart();
                   
                   console.log(`üó∫Ô∏è Loading map for province: ${provinceName}`);
                   await renderTopicBubbles(topicElement.value || '', mapDaysElement.value || '30');
                   
                   console.log(`‚úÖ Finished loading data for province: ${provinceName}`);
               });
           }
           
           // Region filter listener
           if (regionElement) {
               regionElement.addEventListener('change', async () => {
                   const value = regionElement.value;
                   const pid = provinceElement ? provinceElement.value : '';
                   const params = new URLSearchParams();
                   if (pid) params.set('province_id', pid);
                   if (value) params.set('region', value);
                   history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
                   await loadTrendChart();
                   await renderTopicBubbles(topicElement.value || '', mapDaysElement.value || '30');
               });
           }
           
           // Map event listeners
           if (topicElement) {
               addDebouncedListener(topicElement, 'change', () => renderTopicBubbles(topicElement.value || '', mapDaysElement.value || '30'), 200);
           }
           if (mapDaysElement) {
               addDebouncedListener(mapDaysElement, 'change', () => renderTopicBubbles(topicElement.value || '', mapDaysElement.value || '30'), 200);
           }

           
           // Load chart and bubbles in parallel
           console.log('Loading chart and bubbles...');
           Promise.all([
               loadTrendChart().then(() => {
                   console.log('Chart loaded successfully, hiding fallback');
                   const chartFallback = document.getElementById('chart-fallback');
                   if (chartFallback) chartFallback.style.display = 'none';
               }).catch(e => {
                   console.error('loadTrendChart failed:', e);
                   const chartFallback = document.getElementById('chart-fallback');
                   if (chartFallback) {
                       chartFallback.innerHTML = '<h3>‚ùå Chart Load Failed</h3><p>' + e.message + '</p>';
                   }
               }),
               renderTopicBubbles(topicElement.value || '', mapDaysElement.value || '30').then(() => {
                   console.log('Map loaded successfully, hiding fallback');
                   const mapFallback = document.getElementById('map-fallback');
                   if (mapFallback) mapFallback.style.display = 'none';
               }).catch(e => {
                   console.error('renderTopicBubbles failed:', e);
                   const mapFallback = document.getElementById('map-fallback');
                   if (mapFallback) {
                       mapFallback.innerHTML = '<h3>‚ùå Map Load Failed</h3><p>' + e.message + '</p>';
                   }
               })
           ]);
           
           // Initialize notification system
           initNotificationSystem();
           console.log('Dashboard initialization complete');
       });

     // ============ Notification System ==========
     let notificationCount = 0;
     let notificationsVisible = false;

     function initNotificationSystem() {
         // Check for new activities every 60 seconds instead of 30 (reduce load)
         setInterval(checkForNewActivities, 60000);
         
         // Show welcome notification immediately instead of 1 second delay
         showNotification('success', 'Dashboard Ready', 'Admin dashboard loaded successfully!');
     }

     function showNotification(type, title, message, autoHide = true) {
         const notificationCenter = document.getElementById('notificationCenter');
         const notification = document.createElement('div');
         notification.className = `notification ${type}`;
         
         const now = new Date();
         const timeStr = now.toLocaleTimeString('id-ID', {
             hour: '2-digit',
             minute: '2-digit'
         });
         
         notification.innerHTML = `
             <div class="notification-header">
                 <span>${title}</span>
                 <button class="notification-close" onclick="removeNotification(this)">√ó</button>
             </div>
             <div class="notification-body">${message}</div>
             <div class="notification-time">${timeStr}</div>
         `;
         
         notificationCenter.appendChild(notification);
         
         // Update badge
         notificationCount++;
         updateNotificationBadge();
         
         // Auto-hide after 5 seconds
         if (autoHide) {
             setTimeout(() => {
                 removeNotification(notification.querySelector('.notification-close'));
             }, 5000);
         }
     }

     function removeNotification(closeBtn) {
         const notification = closeBtn.closest('.notification');
         notification.style.animation = 'slideInRight 0.3s ease-out reverse';
         setTimeout(() => {
             notification.remove();
             notificationCount = Math.max(0, notificationCount - 1);
             updateNotificationBadge();
         }, 300);
     }

     function updateNotificationBadge() {
         const badge = document.getElementById('notificationBadge');
         if (notificationCount > 0) {
             badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
             badge.style.display = 'flex';
         } else {
             badge.style.display = 'none';
         }
     }

     function toggleNotifications() {
         // Mark all as read
         notificationCount = 0;
         updateNotificationBadge();
         
         // Show notification summary
         showNotification('info', 'Notifications', 'All notifications marked as read', true);
     }

     async function checkForNewActivities() {
         try {
             // Check for new users in last minute
             const response = await fetch('/api/admin/recent-activity');
             if (response.ok) {
                 const data = await response.json();
                 
                 if (data.new_users > 0) {
                     showNotification('success', 'New Users', 
                         `${data.new_users} new user${data.new_users > 1 ? 's' : ''} registered`, false);
                 }
                 
                 if (data.new_chats > 0) {
                     showNotification('info', 'Activity Update', 
                         `${data.new_chats} new question${data.new_chats > 1 ? 's' : ''} received`, false);
                 }
                 
                 if (data.errors > 0) {
                     showNotification('error', 'System Alert', 
                         `${data.errors} error${data.errors > 1 ? 's' : ''} detected in the last hour`, false);
                 }
             }
         } catch (error) {
             console.error('Error checking for new activities:', error);
         }
     }

         // Override the existing showAlert function to use the notification system
    function showAlert(message, type) {
        const typeMap = {
            'success': 'success',
            'danger': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        
        showNotification(typeMap[type] || 'info', 'Alert', message, true);
    }

    // Enhanced responsive table functionality
    function makeTablesResponsive() {
        const tables = document.querySelectorAll('table:not(.responsive-wrapped)');
        
        tables.forEach(table => {
            // Skip if already wrapped
            if (table.parentElement.classList.contains('table-responsive')) return;
            
            // Create responsive wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';
            
            // Insert wrapper before table and move table inside
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
            
            // Mark as wrapped
            table.classList.add('responsive-wrapped');
            
            // Add horizontal scroll indicator for mobile
            if (window.innerWidth <= 768) {
                addScrollIndicator(wrapper);
            }
        });
    }

    function addScrollIndicator(wrapper) {
        const table = wrapper.querySelector('table');
        if (!table) return;
        
        const indicator = document.createElement('div');
        indicator.className = 'scroll-indicator';
        indicator.innerHTML = '‚Üê Geser untuk melihat data lengkap ‚Üí';
        indicator.style.cssText = `
            text-align: center;
            padding: 8px;
            font-size: 12px;
            color: #666;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: none;
        `;
        
        wrapper.appendChild(indicator);
        
        // Show indicator if table is scrollable
        if (table.scrollWidth > wrapper.clientWidth) {
            indicator.style.display = 'block';
        }
        
        // Hide indicator when scrolled to end
        wrapper.addEventListener('scroll', () => {
            const scrollLeft = wrapper.scrollLeft;
            const scrollWidth = wrapper.scrollWidth;
            const clientWidth = wrapper.clientWidth;
            
            if (scrollLeft + clientWidth >= scrollWidth - 10) {
                indicator.style.display = 'none';
            } else {
                indicator.style.display = 'block';
            }
        });
    }

    // Mobile-friendly touch improvements
    function enhanceMobileInteractions() {
        // Improve button touch targets
        const buttons = document.querySelectorAll('.action-btn');
        buttons.forEach(btn => {
            btn.style.minHeight = '44px';
            btn.style.minWidth = '44px';
        });
        
        // Add touch feedback to clickable elements
        const clickableElements = document.querySelectorAll('button, .action-btn, .nav-tab, .stat-card');
        clickableElements.forEach(element => {
            element.addEventListener('touchstart', function() {
                this.style.opacity = '0.7';
            });
            
            element.addEventListener('touchend', function() {
                setTimeout(() => {
                    this.style.opacity = '';
                }, 150);
            });
        });
    }

    // Enhanced window resize handler
    function handleWindowResize() {
        // Re-check table responsiveness
        makeTablesResponsive();
        
        // Update chart responsiveness
        if (typeof trendChart !== 'undefined' && trendChart) {
            trendChart.resize();
        }
        
        // Update map responsiveness
        if (typeof map !== 'undefined' && map) {
            setTimeout(() => {
                map.invalidateSize();
            }, 250);
        }
    }

    // Initialize responsive enhancements
    document.addEventListener('DOMContentLoaded', function() {
        makeTablesResponsive();
        enhanceMobileInteractions();
        
        // Add resize listener with debouncing
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleWindowResize, 250);
        });
        
        // Check for tables added dynamically
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            const tables = node.querySelectorAll ? node.querySelectorAll('table') : [];
                            if (tables.length > 0) {
                                makeTablesResponsive();
                            }
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    });
    </script>
</body>
</html>